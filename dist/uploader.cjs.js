/*! uploader.js version 1.0.0 */
"use strict";var noop=function(){},defaultOpt={partSize:1024*Math.pow(2,7),onError:noop,onProgress:noop,onSuccess:noop,headers:{},parallel:1},SESSION_KEY="UPLOAD_FILE",Uploader=function(){function e(e,t){void 0===t&&(t={}),this.progress={},this.res=[],this._xhrs={},this._abortedFiles=[],this.url=e,this.opt=Object.assign({},defaultOpt,t)}return e.prototype.getLoadedFile=function(){var e=sessionStorage.getItem(SESSION_KEY);return e?JSON.parse(e):{}},e.prototype.isLoaded=function(e,t){return t<=this.getLoadedFile()[e]},e.prototype.setLoadedFile=function(e,t){var r=this.getLoadedFile();r[e]=t,sessionStorage.setItem(SESSION_KEY,JSON.stringify(r))},e.prototype.removeLoadedFile=function(e){var t=this.getLoadedFile();delete t[e],sessionStorage.setItem(SESSION_KEY,JSON.stringify(t))},e.prototype.abortAll=function(){for(var e in this._xhrs)this._xhrs.hasOwnProperty(e)&&this.abort(e)},e.prototype.abort=function(e){if(!this._xhrs[e])return console.warn("Can not abort xhr!");this._abortedFiles.push(e),this._xhrs[e].forEach(function(e){if(0<e.readyState&&e.readyState<4)return e.abort()})},e.prototype.submit=function(e){var d=this;if(0<Object.keys(this._xhrs).length)return console.warn("Must be waiting upload finished!");this.res=[];for(var o=e.map(function(i,p){var u=Math.ceil(i.input.size/d.opt.partSize);return d._xhrs[i.uploadId]=[],new Array(u).fill(0).reduce(function(e,t,a){if(d.isLoaded(i.uploadId,a))return e;return e.push(function(){return new Promise(function(t,r){if(-1<d._abortedFiles.indexOf(i.uploadId))return t({type:"abort"});var e=i.input.slice(a*d.opt.partSize,(a+1)*d.opt.partSize),o=new FormData;o.append("file",e);var n=new XMLHttpRequest;for(var s in n.open("post",d.url),n.setRequestHeader("X-File-Id",i.uploadId),n.setRequestHeader("X-File-Name",encodeURIComponent(i.input.name)),n.setRequestHeader("X-Chunk-Num",a+1+""),n.setRequestHeader("X-Chunk-Total",u+""),d.opt.headers)d.opt.headers.hasOwnProperty(s)&&n.setRequestHeader(s,encodeURIComponent(d.opt.headers[s]));n.onload=function(e){return 200===n.status?(d.setLoadedFile(i.uploadId,a),d.opt.onProgress(d.progress),a+1===u&&(d.removeLoadedFile(i.uploadId),d.res[p]=n.response),t(e)):r(n.response)},n.onabort=t,n.onerror=r,n.upload.onprogress=function(e){e.lengthComputable&&(d.progress[i.uploadId]=+(e.loaded/e.total/u+a/u).toFixed(2),a+1!==u&&d.opt.onProgress(d.progress))},n.send(o),d._xhrs[i.uploadId].push(n)})}),e},[])}),n=function(){var t=o.shift();if(t){var r=function(){var e=t.shift();if(!e)return n();e().then(function(e){return"abort"===e.type?n():r()}).catch(d.opt.onError)};r()}else{Object.keys(d._xhrs).filter(function(e){return d._abortedFiles.indexOf(e)<0}).every(function(e){return d._xhrs[e].every(function(e){return 4===e.readyState})})&&(d.opt.onSuccess(d.res.filter(function(e){return e})),d._xhrs={},d.progress={},d._abortedFiles=[])}},t=0,r=Math.max(5,Math.min(this.opt.parallel,e.length));t<r;t++)n()},e}();module.exports=Uploader;
